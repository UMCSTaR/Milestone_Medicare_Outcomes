---
title: "Milestone Evals"
author: "Xilin Chen"
date: "2/18/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,                                     # code
  message = F,
  warning = F,
  error = F,
  comment = NA,
  R.options = list(width = 220),
  dev.args = list(bg = 'transparent'),          # viz
  dev = 'png',
  fig.align = 'center',
  cache = F
  # out.width = '100%',
  # fig.asp = .5,
)    

library(tidyverse)
library(kableExtra)
library(lubridate)
library(tidyext)


kable_df <- function(..., digits=2) {
  kable(...,digits = digits) %>% 
    kable_styling(full_width = F, latex_options = "hold_position")
}
```

This document explores the milestone data for the last year evaluation

```{r load_data}
load("/Volumes/George_Surgeon_Projects/Milestone_vs_Outcomes/milestone_final_year.rdata")

milestone_final_year = milestone_final_year %>% 
  mutate(IntResponseValue = ifelse(IntResponseValue == 0, NA, IntResponseValue))
```


# Descriptive of Milestone

Evaluations are from 2015 to 2018, Mid-year and Year-end evals within each year. The number of graduates in milestone evals are `r n_distinct(milestone_final_year$PersonID)`

```{r evals}
milestone_final_year %>% 
  cat_by(eval_peroid) %>% 
  kable_df()

milestone_final_year %>% 
  distinct(QuestionKey, ReportCategory, QuestionText) %>% 
  kable_df(caption = "Evaluation Questions")

```

most of the results are between 7-9

```{r summary}
milestone_final_year %>% 
  cat_by(IntResponseValue)

milestone_final_year %>% 
  cat_by(IntResponseValue) %>% 
  ggplot(aes(x = IntResponseValue, y = N)) +
  geom_col() +
  theme_classic()
```

How many residents have <7 evals

```{r low_eval}
milestone_final_year %>% 
  filter(IntResponseValue<7) %>% 
  summarise(n_trainees_less_7 = length(unique(PersonID)))

test = milestone_final_year %>% 
  filter(IntResponseValue<7) %>% 
  cat_by(ReportCategory, IntResponseValue)

low_value_person = milestone_final_year %>% 
  filter(IntResponseValue <=3) %>% 
  distinct(PersonID) %>% 
  pull()

milestone_final_year %>% 
  filter(!is.na(IntResponseValue)) %>% 
  distinct(IntResponseValue, ReportCategory) %>% 
  ggplot(aes(x = IntResponseValue, y = ReportCategory), al) +
  geom_point()

```

```{r sample_person}
sample_person = milestone_final_year %>%
  filter(PersonID == "616007")

sample_person %>% 
  group_by(eval_peroid, ReportCategory) %>% 
  mutate(IntResponseValue = as.numeric(IntResponseValue),
         mean_value = mean(IntResponseValue, na.rm = T)) %>% 
  distinct(eval_peroid, ReportCategory, mean_value)
```


# Sum Milestone Score

```{r milestone_score}
test = milestone_final_year %>% 
  filter(grepl('Year-End', eval_peroid)) %>%   # filter to end-year evaluations
  group_by(PersonID, ReportCategory) %>% 
  mutate(IntResponseValue = as.numeric(IntResponseValue),
         sum_value = sum(IntResponseValue),
         mean_value = mean(IntResponseValue)) %>% 
  ungroup() %>% 
  glimpse()

test2 = test %>% 
  select(PersonID, ReportCategory, eval_peroid,residentyear, IntResponseValue, sum_value) %>% 
  filter(PersonID == "745648")
```

