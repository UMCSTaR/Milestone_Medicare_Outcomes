---
title: "Descriptive Stats for Milestone Medicare 2015-2017"
subtitle: "Max `r params$n_month` months after graduation"
author: "Xilin Chen"
date: "`r Sys.Date()`"
always_allow_html: true
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
params:
  n_month: 12
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,                                     # code
  message = F,
  warning = F,
  error = F,
  comment = NA,
  R.options = list(width = 220),
  dev.args = list(bg = 'transparent'),          # viz
  fig.align = 'center',
  cache = F
)

library(tidyverse)
library(DT)
library(tidyext)
library(kableExtra)
library(arsenal)
library(glmmTMB)
library(mixedup)
library(ggeffects)


kable_df <- function(..., digits=2) {
  kable(...,digits = digits, booktabs = T) %>% 
    kable_styling(full_width = F,
                  latex_options = c("striped", "hold_position"))
    # kable_styling(full_width = F)
}

sum_table <- function(name = "overall_mean",
                      rating_var = IntResponseValue_mean) {
  rating_var = enquo(rating_var)

  milestone_medicare_pc %>%
    mutate(!!name := round(!!rating_var)) %>%
    group_by(!!!syms(name)) %>%
    mutate(
      n_surgeons = length(unique(id_physician_npi)),
      n_cases = n(),
      n_severe_cmp_poa = sum(flg_cmp_po_severe_not_poa),
      rate_severe_cmp_poa = n_severe_cmp_poa / n_cases,
      n_death = sum(flg_death_30d),
      rate_death = n_death / n_cases,
      n_reop = sum(flg_util_reop),
      rate_reop = n_reop / n_cases,
      n_readmit = sum(flg_readmit_30d),
      rate_readmit = n_readmit / n_cases
    ) %>%
    ungroup() %>%
    distinct(
      !!!syms(name),
      n_surgeons,
      n_cases,
      n_severe_cmp_poa,
      rate_severe_cmp_poa,
      n_death,
      rate_death,
      n_reop,
      rate_reop,
      rate_reop,
      n_readmit,
      rate_readmit
    ) %>%
    arrange(!!!syms(name)) %>%
    datatable(rownames = F, options = list(scrollX = T)) %>%
    formatPercentage(c(
      'rate_severe_cmp_poa',
      'rate_death',
      'rate_reop',
      'rate_readmit'
    ),
    2)
}

```


This document uses the end-year milestone evaluations at the last year of residency from ACGME. Milestone rating for each resident is the mean of all 16 questions. The data is linked medicare with milestoner evals.

### Number of cases by procedure

```{r load_data}
load("/Volumes/George_Surgeon_Projects/Milestone_vs_Outcomes/data_08_03/milestone_medicare_all_procedure_1case.rdata")
load("/Volumes/George_Surgeon_Projects/Milestone_vs_Outcomes/milestone_medicare_ratings.rdata")

all_proc = milestone_medicare_gs_1case %>% 
  filter(month <= params$n_month)
# keep valid rating score
milestone_medicare_pc = milestone_medicare_ratings %>% 
  filter(!is.na(IntResponseValue_mean),
         month <= params$n_month)

all_proc %>% 
  count(e_proc_grp_lbl, sort = T, name = "n_cases") %>% 
  DT::datatable()

# n_distinct(milestone_medicare_ratings$id_physician_npi)

```


#### months after graduation 

```{r month_case}
all_proc %>% 
  group_by(month) %>%
  mutate(n_cases = n(),
         n_surg = n_distinct(id_physician_npi)) %>% 
  distinct(month, n_cases, n_surg) %>% 
  arrange(month) %>% 
  rename(month_after_grad = month) %>% 
  DT::datatable(rownames = F)
```

Note: trainees who graduated in 2017 only had 6 months medicare cases.


### Cohort Data Description for Partial Colectomy

```{r data_desc}
milestone_medicare_pc = milestone_medicare_pc %>% 
  mutate(flg_cmp_po_any_not_poa = as.numeric(flg_cmp_po_any_not_poa),
         flg_cmp_po_severe_not_poa = as.numeric(flg_cmp_po_severe_not_poa))


milestone_medicare_pc %>% 
  summarise(n_case = n(),
            n_surgeon = length(unique(id_physician_npi)),
            n_hosp = length(unique(facility_prvnumgrp)),
            POA_severe_complication_rate = sum(flg_cmp_po_severe_not_poa)/n_case,
            severe_complication_rate = sum(flg_cmp_po_severe)/n_case,
            POA_any_complication_rate = sum(flg_cmp_po_any_not_poa)/n_case,
            any_complication_rate = sum(flg_cmp_po_any)/n_case,
            death_rate = sum(flg_death_30d)/n_case,
            readmit = sum(flg_readmit_30d)/n_case,
            reop = sum(flg_util_reop)/n_case) %>% 
  t() %>% 
  kable_df(caption = "Medicare Outcomes Description for PC")
```

### Trainees by Year

```{r trainees_by_year}
milestone_medicare_pc %>% 
  distinct(id_physician_npi, grad_year) %>% 
  count(grad_year, name = "number of surgeons") %>% 
  kable_df(caption = "number of sugeons by graduation year in medicare PC")


milestone_medicare_pc %>% 
  count(grad_year, name = "number of cases") %>% 
  kable_df(caption = "number of cases by graduation year in medicare PC")

surg_case_year = left_join(
  milestone_medicare_pc %>%
    group_by(facility_clm_yr) %>%
    distinct(id_physician_npi, grad_year) %>%
    count(grad_year, name = "number of surgeons")  %>%
    mutate(facility_clm_yr = facility_clm_yr + 2007) ,
  milestone_medicare_pc %>%
    group_by(facility_clm_yr) %>%
    count(grad_year, name = "number of cases")  %>%
    mutate(facility_clm_yr = facility_clm_yr + 2007)
) %>% 
  mutate(`cases per surg` = `number of cases`/`number of surgeons`,
         `cases per surg` = round(`cases per surg`, 2) )  %>%
  ungroup()

surg_case_year %>% 
  DT::datatable(caption = "number of surg and cases by graduation year and medicare year", rownames = F)

```



### Milestone Ratings vs Descriptive Outcomes for Patial Colectomy

```{r rating}
person_rating = milestone_medicare_pc %>%
  distinct(
    id_physician_npi,
    IntResponseValue_mean,
    never_less_8_rating,
    mean_ge_8,
    
    prof_rating_mean,
    prof_rating_ge8,
    
    operative_rating_mean,
    operative_rating_ge8,
    
    leadership_rating_mean,
    leadership_rating_ge8
  )
```

#### Overall mean of 16 milestone ratings

```{r mean_overall}
# mean overall------
# debugonce(sum_table)
sum_table(rating_var = IntResponseValue_mean, 
          name = "overall_mean")
```


####  Death Descriptive

```{r death}
death_case = milestone_medicare_pc %>%
  filter(flg_death_30d == 1) %>%
  transmute(
    overall_mean = round(IntResponseValue_mean),
    flg_death_30d,
    # covers
    flg_male,
    age_at_admit,
    race_white,
    race_hisp_other,
    flg_admit_emerg,
    AHRQ_score,
    ses_2grp,
    # 'cpt_cd',
    facility_clm_yr,
    flg_multi_surgeon,
    flg_assistant_surgeon,
    hosp_beds_2grp,
    # 'flg_hosp_ICU_hosp',
    val_hosp_mcday2inptday_ratio,
    val_hosp_rn2bed_ratio
  )
```

Based on the model results, age(negative), admit emergent (negative) status and multiple surgeons performance (positive) are 3 variables that had statistically significance on death within 30 days. Below are the descriptive stats for each overall milestone score.

```{r death_cov}
case_by_mean_milestone = milestone_medicare_pc %>% 
  mutate(overall_mean = round(IntResponseValue_mean)) %>% 
  group_by(overall_mean) %>% 
  summarise(n_case = n()) 

death_case %>%
  group_by(overall_mean) %>%
  summarise(n_cases_death = n(),
            emergent_admit_rate = mean(flg_admit_emerg, na.rm = T),
            emergent_admit_rate = scales::percent(emergent_admit_rate),
            age = mean(age_at_admit),
            multi_surg = mean(flg_multi_surgeon),
            multi_surg = scales::percent(multi_surg)) %>% 
  left_join(case_by_mean_milestone) %>% 
  select(overall_mean, n_case, n_cases_death, everything()) %>% 
  kable_df()
```

In order to understand the milestone rating vs. death relationship, without considering other covariates. Below are the univariate analysis between death within 30 days and mean of milestone rating for 30 months practice

```{r uni_model_death}
load("~/Documents/Repo/Milestone_Medicare_Outcomes/data/uni_death_model_no_limit_model.rdata")

uni_death_model_no_limit %>% 
  mutate(OR = exp(estimate)) %>% 
  select(term, OR, everything()) %>% 
  kable_df()
```

Without controlling for covariate, higher overall milestone ratings had lower patient mortality rate.


#### Overall mean milestone ratings greater or equal to 8 

Note: not matched with the numbers above because of rounding.

```{r mean_lt_8}
# overall mean less than 8 -----
sum_table(rating_var = mean_ge_8, 
          name = "overall_mean_gt_8")
```

#### All Milestone ratings are greater or equal to 8

```{r ever_lt_8}
# ever_less_8_rating-----
sum_table(rating_var = never_less_8_rating, 
          name = "never_have_lt8_rating")
```

#### professional ratings mean (comp5_PR_Q1, comp5_PR_Q2, comp5_PR_Q3)

```{r prof_rating_mean}
# prof_rating_mean -----
sum_table(rating_var = prof_rating_mean, 
          name = "prof_rating_mean")
```

**Mean of professional ratings are greater or equal to 8**
```{r prof_rating_mean2}
sum_table(rating_var = prof_rating_ge8, 
          name = "prof_rating_ge8")

```

#### leadership ratings mean (comp5_PR_Q1, comp6_ICS_Q1, comp6_ICS_Q2, comp3_SBP_Q")

```{r leadership_rating_mean}
# leadership_rating_mean----
sum_table(rating_var = leadership_rating_mean, 
          name = "leadership_rating_mean")
```

**Mean of leadership ratings are greater or equal to 8**

```{r leadership_rating_mean2}
sum_table(rating_var = leadership_rating_ge8, 
          name = "leadership_rating_ge8")
```

#### Operative ratings mean (PC3, MK2, ICS3)

```{r operative_rating_mean}
# operative_rating_mean---
sum_table(rating_var = operative_rating_mean, 
          name = "operative_rating_mean")
```

**Mean of operative ratings are greater or equal to 8** 

```{r operative_rating_mean2}
sum_table(rating_var = operative_rating_ge8, 
          name = "operative_rating_ge8")

```



